
<!DOCTYPE html>


<html lang="en" data-content_root="../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Core Classes &#8212; Ultimo 0.1 documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="../_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=a746c00c" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="../_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="../_static/documentation_options.js?v=2709fde1"></script>
    <script src="../_static/doctools.js?v=9a2dae69"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'user_guide/core_classes';</script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Machine Classes" href="machine_classes.html" />
    <link rel="prev" title="Getting Started" href="installation.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search the docs ..."
         aria-label="Search the docs ..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
<div class="bd-header__inner bd-page-width">
  <button class="pst-navbar-icon sidebar-toggle primary-toggle" aria-label="Site navigation">
    <span class="fa-solid fa-bars"></span>
  </button>
  
  
  <div class="col-lg-3 navbar-header-items__start">
    
      <div class="navbar-item">

  
    
  

<a class="navbar-brand logo" href="../index.html">
  
  
  
  
  
  
    <p class="title logo__title">Ultimo 0.1 documentation</p>
  
</a></div>
    
  </div>
  
  <div class="col-lg-9 navbar-header-items">
    
    <div class="me-auto navbar-header-items__center">
      
        <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item current active">
  <a class="nav-link nav-internal" href="../user_guide.html">
    Ultimo User Guide
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../api.html">
    API
  </a>
</li>

  </ul>
</nav></div>
      
    </div>
    
    
    <div class="navbar-header-items__end">
      
        <div class="navbar-item navbar-persistent--container">
          

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script>
        </div>
      
      
        <div class="navbar-item">

<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script></div>
      
    </div>
    
  </div>
  
  
    <div class="navbar-persistent--mobile">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script>
    </div>
  

  
    <button class="pst-navbar-icon sidebar-toggle secondary-toggle" aria-label="On this page">
      <span class="fa-solid fa-outdent"></span>
    </button>
  
</div>

    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
      <div class="sidebar-header-items__center">
        
          
          
            <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item current active">
  <a class="nav-link nav-internal" href="../user_guide.html">
    Ultimo User Guide
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../api.html">
    API
  </a>
</li>

  </ul>
</nav></div>
          
        
      </div>
    
    
    
      <div class="sidebar-header-items__end">
        
          <div class="navbar-item">

<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script></div>
        
      </div>
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">
<nav class="bd-docs-nav bd-links"
     aria-label="Section Navigation">
  <p class="bd-links__title" role="heading" aria-level="1">Section Navigation</p>
  <div class="bd-toc-item navbar-nav"><p aria-level="2" class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="introduction.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="installation.html">Getting Started</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Core Classes</a></li>
<li class="toctree-l1"><a class="reference internal" href="machine_classes.html">Machine Classes</a></li>
<li class="toctree-l1"><a class="reference internal" href="display_classes.html">Display Classes</a></li>
<li class="toctree-l1"><a class="reference internal" href="customization.html">Customization</a></li>
<li class="toctree-l1"><a class="reference internal" href="examples.html">Examples</a></li>
</ul>
</div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        
          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item">



<nav aria-label="Breadcrumb" class="d-print-none">
  <ul class="bd-breadcrumbs">
    
    <li class="breadcrumb-item breadcrumb-home">
      <a href="../index.html" class="nav-link" aria-label="Home">
        <i class="fa-solid fa-home"></i>
      </a>
    </li>
    
    <li class="breadcrumb-item"><a href="../user_guide.html" class="nav-link">Ultimo User Guide</a></li>
    
    <li class="breadcrumb-item active" aria-current="page">Core Classes</li>
  </ul>
</nav>
</div>
      
    </div>
  
  
</div>
</div>
              
              
              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section id="core-classes">
<h1>Core Classes<a class="headerlink" href="#core-classes" title="Link to this heading">#</a></h1>
<p>The core classes are the building-blocks for Ultimo.  They defined the basic
behaviour of the asynchronous iterators that define the application data flow.</p>
<section id="asource-classes">
<h2>ASource Classes<a class="headerlink" href="#asource-classes" title="Link to this heading">#</a></h2>
<p>Ultimo provides a slightly richer API for its iteratable objects.  In addition
to being used in <code class="docutils literal notranslate"><span class="pre">async</span> <span class="pre">for</span> <span class="pre">...</span></code> similar iterator contexts, the iteratable
objects can be asynchronously called to generate an immediate value (eg. by
querying the underlying hardware, or returning a cached value).  This protocol
is embodied in the <a class="reference internal" href="../generated/ultimo.core.ASource.html#ultimo.core.ASource" title="ultimo.core.ASource"><code class="xref py py-class docutils literal notranslate"><span class="pre">ASource</span></code></a> base class.</p>
<p>The corresponding iterator objects are subclasses of <a class="reference internal" href="../generated/ultimo.core.AFlow.html#ultimo.core.AFlow" title="ultimo.core.AFlow"><code class="xref py py-class docutils literal notranslate"><span class="pre">AFlow</span></code></a> and
by default each <a class="reference internal" href="../generated/ultimo.core.ASource.html#ultimo.core.ASource" title="ultimo.core.ASource"><code class="xref py py-class docutils literal notranslate"><span class="pre">ASource</span></code></a> has a particular <a class="reference internal" href="../generated/ultimo.core.AFlow.html#ultimo.core.AFlow" title="ultimo.core.AFlow"><code class="xref py py-class docutils literal notranslate"><span class="pre">AFlow</span></code></a> subclass
that it creates when iterating.</p>
<p>Ultimo has a number of builtin <a class="reference internal" href="../generated/ultimo.core.ASource.html#ultimo.core.ASource" title="ultimo.core.ASource"><code class="xref py py-class docutils literal notranslate"><span class="pre">ASource</span></code></a> subclasses that handle common
cases.</p>
<section id="poll">
<h3>Poll<a class="headerlink" href="#poll" title="Link to this heading">#</a></h3>
<p>The simplest way to create a source is by polling a callable at an interval.
The <a class="reference internal" href="../generated/ultimo.poll.Poll.html#ultimo.poll.Poll" title="ultimo.poll.Poll"><code class="xref py py-class docutils literal notranslate"><span class="pre">Poll</span></code></a> class does this.  For example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">machine</span> <span class="kn">import</span> <span class="n">RTC</span>

<span class="n">rtc</span> <span class="o">=</span> <span class="n">RTC</span><span class="p">()</span>
<span class="n">clock</span> <span class="o">=</span> <span class="n">Poll</span><span class="p">(</span><span class="n">rtc</span><span class="o">.</span><span class="n">datetime</span><span class="p">,</span> <span class="n">interval</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
<p>or:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">machine</span> <span class="kn">import</span> <span class="n">ADC</span><span class="p">,</span> <span class="n">Pin</span>

<span class="n">_adc</span> <span class="o">=</span> <span class="n">ADC</span><span class="p">(</span><span class="n">Pin</span><span class="p">(</span><span class="mi">19</span><span class="p">))</span>
<span class="n">adc</span> <span class="o">=</span> <span class="n">Poll</span><span class="p">(</span><span class="n">_adc</span><span class="o">.</span><span class="n">read_16</span><span class="p">,</span> <span class="n">interval</span><span class="o">=</span><span class="mf">0.01</span><span class="p">)</span>
</pre></div>
</div>
<p>The <a class="reference internal" href="../generated/ultimo.poll.Poll.html#ultimo.poll.Poll" title="ultimo.poll.Poll"><code class="xref py py-class docutils literal notranslate"><span class="pre">Poll</span></code></a> object expects the callable to be called with no arguments, so more
complex function signatures may need to be wrapped in a helper function,
partial or callable class, as appropriate.  The callable can be a regular
synchronous function or asynchronous coroutine, which should ideally avoid
setting any shared state (or carefully use locks if it must).</p>
<p><a class="reference internal" href="../generated/ultimo.poll.Poll.html#ultimo.poll.Poll" title="ultimo.poll.Poll"><code class="xref py py-class docutils literal notranslate"><span class="pre">Poll</span></code></a> objects can also be called, which simply invokes to the underlying
callable.</p>
</section>
<section id="eventsource">
<h3>EventSource<a class="headerlink" href="#eventsource" title="Link to this heading">#</a></h3>
<p>The alternative to polling is to wait for an asynchronous event.  The
<a class="reference internal" href="../generated/ultimo.core.EventSource.html#ultimo.core.EventSource" title="ultimo.core.EventSource"><code class="xref py py-class docutils literal notranslate"><span class="pre">EventSource</span></code></a> asbtract class provides the basic infrastructure for
users to subclass by providing an appropriate <code class="xref py py-meth docutils literal notranslate"><span class="pre">__call__()</span></code> method.
The <a class="reference internal" href="../generated/ultimo.core.ThreadSafeSource.html#ultimo.core.ThreadSafeSource" title="ultimo.core.ThreadSafeSource"><code class="xref py py-class docutils literal notranslate"><span class="pre">ThreadSafeSource</span></code></a> class is a subclass that uses a
<a class="reference external" href="https://docs.micropython.org/en/latest/library/asyncio.html#asyncio.ThreadSafeFlag" title="(in MicroPython vlatest)"><code class="xref py py-class docutils literal notranslate"><span class="pre">asyncio.ThreadSafeFlag</span></code></a>  instead of an <a class="reference external" href="https://docs.micropython.org/en/latest/library/asyncio.html#asyncio.Event" title="(in MicroPython vlatest)"><code class="xref py py-class docutils literal notranslate"><span class="pre">asyncio.Event</span></code></a>.</p>
<p>The event that the iterator waits for the event to be set by regular Python
code calling the <a class="reference internal" href="../generated/ultimo.core.EventSource.html#ultimo.core.EventSource.fire" title="ultimo.core.EventSource.fire"><code class="xref py py-meth docutils literal notranslate"><span class="pre">fire()</span></code></a> method, or an
interrupt handler (carefully!) setting a <a class="reference external" href="https://docs.micropython.org/en/latest/library/asyncio.html#asyncio.ThreadSafeFlag" title="(in MicroPython vlatest)"><code class="xref py py-class docutils literal notranslate"><span class="pre">asyncio.ThreadSafeFlag</span></code></a>.</p>
<p>For example, the following class provides a class for handling IRQs from a
<a class="reference external" href="https://docs.micropython.org/en/latest/library/machine.Pin.html#machine.Pin" title="(in MicroPython vlatest)"><code class="xref py py-class docutils literal notranslate"><span class="pre">Pin</span></code></a>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Interrupt</span><span class="p">(</span><span class="n">ThreadSafeSource</span><span class="p">):</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pin</span><span class="p">,</span> <span class="n">trigger</span><span class="o">=</span><span class="n">Pin</span><span class="o">.</span><span class="n">IRQ_RISING</span> <span class="o">|</span> <span class="n">Pin</span><span class="o">.</span><span class="n">IRQ_FALLING</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pin</span> <span class="o">=</span> <span class="n">pin</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trigger</span> <span class="o">=</span> <span class="n">trigger</span>

    <span class="k">async</span> <span class="k">def</span> <span class="fm">__aenter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">set_flag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">event</span><span class="o">.</span><span class="n">set</span>

        <span class="k">def</span> <span class="nf">isr</span><span class="p">(</span><span class="n">_</span><span class="p">):</span>
            <span class="n">set_flag</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">pin</span><span class="o">.</span><span class="n">irq</span><span class="p">(</span><span class="n">isr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">trigger</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">async</span> <span class="k">def</span> <span class="fm">__aexit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="k">async</span> <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">pin</span><span class="p">()</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pin</span><span class="o">.</span><span class="n">irq</span><span class="p">()</span>
</pre></div>
</div>
<p>As with all interrupt-based code in micropython, care needs to be taken in
the interrupt handler and the iterator method so that the code is fast,
robust and reentrant.  Also note that although interrupt handlers may be
fast, any <a class="reference internal" href="../generated/ultimo.core.EventFlow.html#ultimo.core.EventFlow" title="ultimo.core.EventFlow"><code class="xref py py-class docutils literal notranslate"><span class="pre">EventFlow</span></code></a> instances watching the event will be dispatched by
the</p>
</section>
<section id="streams">
<h3>Streams<a class="headerlink" href="#streams" title="Link to this heading">#</a></h3>
<p>The <a class="reference internal" href="../generated/ultimo.stream.ARead.html#ultimo.stream.ARead" title="ultimo.stream.ARead"><code class="xref py py-class docutils literal notranslate"><span class="pre">ARead</span></code></a> source wraps a readable IO stream (<a class="reference external" href="https://docs.micropython.org/en/latest/library/sys.html#sys.stdin" title="(in MicroPython vlatest)"><code class="xref py py-obj docutils literal notranslate"><span class="pre">sys.stdin</span></code></a> by default)
and when iterated over returns each byte (or char from a text file) from the
stream until the stream is closed.  To help with clean-up, <a class="reference internal" href="../generated/ultimo.stream.ARead.html#ultimo.stream.ARead" title="ultimo.stream.ARead"><code class="xref py py-class docutils literal notranslate"><span class="pre">ARead</span></code></a> is also a
async context manager that will close the stream on exit.</p>
</section>
<section id="values">
<h3>Values<a class="headerlink" href="#values" title="Link to this heading">#</a></h3>
<p>A <a class="reference internal" href="../generated/ultimo.value.Value.html#ultimo.value.Value" title="ultimo.value.Value"><code class="xref py py-class docutils literal notranslate"><span class="pre">Value</span></code></a> is an <a class="reference internal" href="../generated/ultimo.core.EventSource.html#ultimo.core.EventSource" title="ultimo.core.EventSource"><code class="xref py py-class docutils literal notranslate"><span class="pre">EventSource</span></code></a> which holds a value as state
and fires an event every time the value is updated (either by calling the
instance with the new value, or calling the <a class="reference internal" href="../generated/ultimo.value.Value.html#ultimo.value.Value.update" title="ultimo.value.Value.update"><code class="xref py py-meth docutils literal notranslate"><span class="pre">update()</span></code></a> method).
Iterating over a <a class="reference internal" href="../generated/ultimo.value.Value.html#ultimo.value.Value" title="ultimo.value.Value"><code class="xref py py-class docutils literal notranslate"><span class="pre">Value</span></code></a> asynchronously generates the values as they
are changed.</p>
<p>An <a class="reference internal" href="../generated/ultimo.value.EasedValue.html#ultimo.value.EasedValue" title="ultimo.value.EasedValue"><code class="xref py py-class docutils literal notranslate"><span class="pre">EasedValue</span></code></a> is a value which when set is transitioned into its new
value over time by an easing formula.  The intermediate values will be emitted
by the iterator.</p>
</section>
</section>
<section id="asink-classes">
<h2>ASink Classes<a class="headerlink" href="#asink-classes" title="Link to this heading">#</a></h2>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The <a class="reference internal" href="../generated/ultimo.core.ASink.html#ultimo.core.ASink" title="ultimo.core.ASink"><code class="xref py py-class docutils literal notranslate"><span class="pre">ASink</span></code></a> class is very thin, and most behaviour can be achieved by an
async function with an async for loop.  Currently the <a class="reference internal" href="../generated/ultimo.stream.AWrite.html#ultimo.stream.AWrite" title="ultimo.stream.AWrite"><code class="xref py py-class docutils literal notranslate"><span class="pre">AWrite</span></code></a> class is
the most compelling reason for this to exist.  It’s possible that this
concept may be removed in future versions.</p>
</div>
<p>A common pattern for the eventual result of a chain of iterators is a simple
async for loop which looks something like:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">try</span><span class="p">:</span>
    <span class="k">async</span> <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">source</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">process</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
<span class="k">except</span> <span class="n">uasyncio</span><span class="o">.</span><span class="n">CancelError</span><span class="p">:</span>
    <span class="k">pass</span>
</pre></div>
</div>
<p>This is common enough that Ultimo provides an <a class="reference internal" href="../generated/ultimo.core.ASink.html#ultimo.core.ASink" title="ultimo.core.ASink"><code class="xref py py-class docutils literal notranslate"><span class="pre">ASink</span></code></a> base class which wraps
a source and has a <a class="reference internal" href="../generated/ultimo.core.ASink.html#ultimo.core.ASink.run" title="ultimo.core.ASink.run"><code class="xref py py-meth docutils literal notranslate"><span class="pre">run()</span></code></a> method that asynchronously consumes the source,
calling its <code class="xref py py-meth docutils literal notranslate"><span class="pre">process()</span></code> method on each generated value, until the source is
exhausted or the task cancelled.</p>
<p>While sinks can be generated with a source provided as an argument, they also
support a pipe-style syntax with the <code class="docutils literal notranslate"><span class="pre">|</span></code> operator, so rather than writing:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">source</span> <span class="o">=</span> <span class="n">MySource</span><span class="p">()</span>
<span class="n">sink</span> <span class="o">=</span> <span class="n">MySink</span><span class="p">(</span><span class="n">source</span><span class="o">=</span><span class="n">source</span><span class="p">)</span>
<span class="n">uasyncio</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="n">sink</span><span class="o">.</span><span class="n">run</span><span class="p">())</span>
</pre></div>
</div>
<p>they can be connected using:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sink</span> <span class="o">=</span> <span class="n">MySource</span><span class="p">()</span> <span class="o">|</span> <span class="n">MySink</span><span class="p">()</span>
<span class="n">uasyncio</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="n">sink</span><span class="o">.</span><span class="n">run</span><span class="p">())</span>
</pre></div>
</div>
<section id="consumers">
<h3>Consumers<a class="headerlink" href="#consumers" title="Link to this heading">#</a></h3>
<p>In many cases, a sink just needs to asyncronously call a function.  The
<a class="reference internal" href="../generated/ultimo.core.Consumer.html#ultimo.core.Consumer" title="ultimo.core.Consumer"><code class="xref py py-class docutils literal notranslate"><span class="pre">Consumer</span></code></a> class provides a simple <a class="reference internal" href="../generated/ultimo.core.ASink.html#ultimo.core.ASink" title="ultimo.core.ASink"><code class="xref py py-class docutils literal notranslate"><span class="pre">ASink</span></code></a> which wraps an asynchronous
callable which is called with the source values as the first argument
by the <code class="xref py py-meth docutils literal notranslate"><span class="pre">process()</span></code> method:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">async</span> <span class="k">def</span> <span class="nf">display</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">lcd</span><span class="p">):</span>
    <span class="n">lcd</span><span class="o">.</span><span class="n">write_data</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

<span class="n">lcd</span> <span class="o">=</span> <span class="o">...</span>
<span class="n">display_sink</span> <span class="o">=</span> <span class="n">Consumer</span><span class="p">(</span><span class="n">display</span><span class="p">,</span> <span class="n">lcd</span><span class="p">)</span>
</pre></div>
</div>
<p>There are also helper decorators <a class="reference internal" href="../generated/ultimo.core.html#ultimo.core.sink" title="ultimo.core.sink"><code class="xref py py-func docutils literal notranslate"><span class="pre">sink()</span></code></a> and <a class="reference internal" href="../generated/ultimo.core.html#ultimo.core.asink" title="ultimo.core.asink"><code class="xref py py-func docutils literal notranslate"><span class="pre">asink()</span></code></a> that wrap functions
and produce factories that produce consumers for the functions:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nd">@sink</span>
<span class="k">def</span> <span class="nf">display</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">lcd</span><span class="p">):</span>
    <span class="n">lcd</span><span class="o">.</span><span class="n">write_data</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

<span class="n">lcd</span> <span class="o">=</span> <span class="o">...</span>
<span class="n">display_sink</span> <span class="o">=</span> <span class="n">display</span><span class="p">(</span><span class="n">lcd</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="id1">
<h3>Streams<a class="headerlink" href="#id1" title="Link to this heading">#</a></h3>
<p>The <a class="reference internal" href="../generated/ultimo.stream.AWrite.html#ultimo.stream.AWrite" title="ultimo.stream.AWrite"><code class="xref py py-class docutils literal notranslate"><span class="pre">AWrite</span></code></a> source wraps a writable IO stream (<a class="reference external" href="https://docs.micropython.org/en/latest/library/sys.html#sys.stdout" title="(in MicroPython vlatest)"><code class="xref py py-obj docutils literal notranslate"><span class="pre">sys.stdout</span></code></a> by
default) and consumes a stream of <code class="xref py py-type docutils literal notranslate"><span class="pre">bytes</span></code> objects (or
<code class="xref py py-type docutils literal notranslate"><span class="pre">str</span></code> for a text stream) which it writes to the stream until the
stream is closed.  To help with clean-up, <a class="reference internal" href="../generated/ultimo.stream.AWrite.html#ultimo.stream.AWrite" title="ultimo.stream.AWrite"><code class="xref py py-class docutils literal notranslate"><span class="pre">AWrite</span></code></a> is also a async context
manager that will close the stream on exit.</p>
</section>
</section>
<section id="pipelines">
<h2>Pipelines<a class="headerlink" href="#pipelines" title="Link to this heading">#</a></h2>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The <a class="reference internal" href="../generated/ultimo.core.APipeline.html#ultimo.core.APipeline" title="ultimo.core.APipeline"><code class="xref py py-class docutils literal notranslate"><span class="pre">APipeline</span></code></a> class exists primarily because Micropython doesn’t
currently support asynchronous generator functions.</p>
</div>
<p>Often you want to do some further processing on the raw output from a device.
For example, you may want to convert the data into a more useful format,
smooth a noisy signal, debounce a button press, or de-duplicate a repetitive
iterator.  Ultimo provides the <a class="reference internal" href="../generated/ultimo.core.APipeline.html#ultimo.core.APipeline" title="ultimo.core.APipeline"><code class="xref py py-class docutils literal notranslate"><span class="pre">APipeline</span></code></a> base class for sources
which transform another source.</p>
<p>These include:</p>
<div class="pst-scrollable-table-container"><table class="autosummary longtable table autosummary">
<tbody>
<tr class="row-odd"><td><p><a class="reference internal" href="../generated/ultimo.pipelines.Apply.html#ultimo.pipelines.Apply" title="ultimo.pipelines.Apply"><code class="xref py py-obj docutils literal notranslate"><span class="pre">Apply</span></code></a>(coroutine[, args, kwargs, source])</p></td>
<td><p>Pipeline that applies a callable to each value.</p></td>
</tr>
<tr class="row-even"><td><p><a class="reference internal" href="../generated/ultimo.pipelines.Debounce.html#ultimo.pipelines.Debounce" title="ultimo.pipelines.Debounce"><code class="xref py py-obj docutils literal notranslate"><span class="pre">Debounce</span></code></a>([delay, source])</p></td>
<td><p>Pipeline that stabilizes polled values emitted for a short time.</p></td>
</tr>
<tr class="row-odd"><td><p><a class="reference internal" href="../generated/ultimo.pipelines.Dedup.html#ultimo.pipelines.Dedup" title="ultimo.pipelines.Dedup"><code class="xref py py-obj docutils literal notranslate"><span class="pre">Dedup</span></code></a>([source])</p></td>
<td><p>Pipeline that ignores repeated values.</p></td>
</tr>
<tr class="row-even"><td><p><a class="reference internal" href="../generated/ultimo.pipelines.EWMA.html#ultimo.pipelines.EWMA" title="ultimo.pipelines.EWMA"><code class="xref py py-obj docutils literal notranslate"><span class="pre">EWMA</span></code></a>([weight, source])</p></td>
<td><p>Pipeline that smoothes values with an exponentially weighted moving average.</p></td>
</tr>
<tr class="row-odd"><td><p><a class="reference internal" href="../generated/ultimo.pipelines.Filter.html#ultimo.pipelines.Filter" title="ultimo.pipelines.Filter"><code class="xref py py-obj docutils literal notranslate"><span class="pre">Filter</span></code></a>(filter[, args, kwargs, source])</p></td>
<td><p>Pipeline that filters values.</p></td>
</tr>
</tbody>
</table>
</div>
<p>For example, a raw ADC output could be converted to a voltage as follows:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">async</span> <span class="k">def</span> <span class="nf">voltage</span><span class="p">(</span><span class="n">raw_value</span><span class="p">):</span>
    <span class="k">return</span> <span class="mf">3.3</span> <span class="o">*</span> <span class="n">raw_value</span> <span class="o">/</span> <span class="mh">0xffff</span>
</pre></div>
</div>
<p>and then this used to wrap the output of an ADC iterator:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">adc_volts</span> <span class="o">=</span> <span class="n">Apply</span><span class="p">(</span><span class="n">adc</span><span class="p">,</span> <span class="n">voltage</span><span class="p">)</span>
</pre></div>
</div>
<p>More succinctly, the <a class="reference internal" href="../generated/ultimo.pipelines.html#ultimo.pipelines.pipe" title="ultimo.pipelines.pipe"><code class="xref py py-func docutils literal notranslate"><span class="pre">pipe()</span></code></a> decorator can be used
as follows:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nd">@pipe</span>
<span class="k">def</span> <span class="nf">voltage</span><span class="p">(</span><span class="n">raw_value</span><span class="p">,</span> <span class="n">max_value</span><span class="o">=</span><span class="mf">3.3</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">max_value</span> <span class="o">*</span> <span class="n">raw_value</span> <span class="o">/</span> <span class="mh">0xffff</span>

<span class="n">adc_volts</span> <span class="o">=</span> <span class="n">voltage</span><span class="p">(</span><span class="n">adc</span><span class="p">)</span>
</pre></div>
</div>
<p>There is a similar <a class="reference internal" href="../generated/ultimo.pipelines.html#ultimo.pipelines.apipe" title="ultimo.pipelines.apipe"><code class="xref py py-func docutils literal notranslate"><span class="pre">apipe()</span></code></a> method that accepts an
asynchronous function.</p>
<p><a class="reference internal" href="../generated/ultimo.core.APipeline.html#ultimo.core.APipeline" title="ultimo.core.APipeline"><code class="xref py py-class docutils literal notranslate"><span class="pre">APipeline</span></code></a> subclasses both <a class="reference internal" href="../generated/ultimo.core.ASource.html#ultimo.core.ASource" title="ultimo.core.ASource"><code class="xref py py-class docutils literal notranslate"><span class="pre">ASource</span></code></a> and <a class="reference internal" href="../generated/ultimo.core.ASink.html#ultimo.core.ASink" title="ultimo.core.ASink"><code class="xref py py-class docutils literal notranslate"><span class="pre">ASink</span></code></a>, so it is both an iteratable and a
has a <a class="reference internal" href="../generated/ultimo.core.ASink.html#ultimo.core.ASink.run" title="ultimo.core.ASink.run"><code class="xref py py-meth docutils literal notranslate"><span class="pre">run()</span></code></a> method that can be used in a task.  Just like other <a class="reference internal" href="../generated/ultimo.core.ASink.html#ultimo.core.ASink" title="ultimo.core.ASink"><code class="xref py py-class docutils literal notranslate"><span class="pre">ASink</span></code></a> subclasses,
<a class="reference internal" href="../generated/ultimo.core.APipeline.html#ultimo.core.APipeline" title="ultimo.core.APipeline"><code class="xref py py-class docutils literal notranslate"><span class="pre">APipeline</span></code></a> classes can use the <cite>|</cite> operator to compose longer data flows:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">display_voltage</span> <span class="o">=</span> <span class="n">ADCSource</span><span class="p">(</span><span class="mi">26</span><span class="p">)</span> <span class="o">|</span> <span class="n">voltage</span><span class="p">()</span> <span class="o">|</span> <span class="n">EWMA</span><span class="p">(</span><span class="mf">0.2</span><span class="p">)</span> <span class="o">|</span> <span class="n">display</span><span class="p">(</span><span class="n">lcd</span><span class="p">)</span>
</pre></div>
</div>
</section>
</section>


                </article>
              
              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="installation.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Getting Started</p>
      </div>
    </a>
    <a class="right-next"
       href="machine_classes.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Machine Classes</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
<div
    id="pst-page-navigation-heading-2"
    class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> On this page
  </div>
  <nav class="bd-toc-nav page-toc" aria-labelledby="pst-page-navigation-heading-2">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#asource-classes">ASource Classes</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#poll">Poll</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#eventsource">EventSource</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#streams">Streams</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#values">Values</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#asink-classes">ASink Classes</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#consumers">Consumers</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id1">Streams</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#pipelines">Pipelines</a></li>
</ul>
  </nav></div>

  <div class="sidebar-secondary-item">

  <div class="tocsection sourcelink">
    <a href="../_sources/user_guide/core_classes.rst.txt">
      <i class="fa-solid fa-file-lines"></i> Show Source
    </a>
  </div>
</div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
          </footer>
        
      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
<div class="bd-footer__inner bd-page-width">
  
    <div class="footer-items__start">
      
        <div class="footer-item">

  <p class="copyright">
    
      © Copyright 2024, Unital Software.
      <br/>
    
  </p>
</div>
      
        <div class="footer-item">

  <p class="sphinx-version">
    Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 8.0.2.
    <br/>
  </p>
</div>
      
    </div>
  
  
  
    <div class="footer-items__end">
      
        <div class="footer-item">
<p class="theme-version">
  Built with the <a href="https://pydata-sphinx-theme.readthedocs.io/en/stable/index.html">PyData Sphinx Theme</a> 0.15.4.
</p></div>
      
    </div>
  
</div>

  </footer>
  </body>
</html>